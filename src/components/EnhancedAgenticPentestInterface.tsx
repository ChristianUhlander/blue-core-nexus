/**
 * Enhanced Agentic Penetration Testing Interface
 * 
 * A production-ready penetration testing configuration interface that provides:
 * - Left Panel: Module Configuration & Selection
 * - Right Panel: Framework Selection, Tool Configuration & Aggression Settings
 * 
 * Features:
 * - Real-time configuration validation
 * - Backend-ready API structure
 * - Comprehensive security framework support
 * - Granular tool selection and configuration
 * - Aggression level management
 * - Export/Import configuration capabilities
 * 
 * @author Security Team
 * @version 2.0.0
 */

import React, { useState, useCallback, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Switch } from "@/components/ui/switch";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Separator } from "@/components/ui/separator";
import { Slider } from "@/components/ui/slider";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Checkbox } from "@/components/ui/checkbox";
import { Sheet, SheetContent } from "@/components/ui/sheet";
import { toast } from "@/hooks/use-toast";
import { LLMReasoningShell } from "./LLMReasoningShell";
import { ShellToggleButton } from "./LLMReasoningShell/ShellToggleButton";
import { useLLMShell } from "@/hooks/useLLMShell";
import { 
  Shield, 
  Target, 
  Settings, 
  AlertTriangle, 
  CheckCircle,
  Download,
  Upload,
  Play,
  Pause,
  RotateCcw,
  Network,
  Globe,
  Lock,
  Search,
  Code,
  Database,
  Bot,
  Terminal,
  Clock,
  TrendingUp,
  Save,
  FileText,
  Eye,
  Gauge,
  BookOpen
} from "lucide-react";

// ===========================
// TYPE DEFINITIONS
// ===========================

/**
 * Represents a penetration testing module configuration
 */
interface PentestModule {
  id: string;
  name: string;
  description: string;
  category: 'reconnaissance' | 'vulnerability-assessment' | 'exploitation' | 'post-exploitation' | 'reporting';
  enabled: boolean;
  priority: number;
  estimatedTime: string;
  requiredTools: string[];
  riskLevel: 'low' | 'medium' | 'high' | 'critical';
  prerequisites?: string[];
}

// Removed: PentestScenarioPhase, PentestScenario, SecurityFramework, SecurityTool interfaces

/**
 * Kali Linux MCP Server Configuration
 */
interface KaliMCPServerConfig {
  enabled: boolean;
  serverEndpoint: string;
  port: number;
  apiKey?: string;
  timeout: number;
  maxRetries: number;
  enabledTools: string[];
  resourceLimits: {
    maxConcurrentJobs: number;
    maxMemoryUsage: string;
    maxExecutionTime: number;
  };
  securitySettings: {
    sandboxMode: boolean;
    allowNetworkAccess: boolean;
    allowSystemCommands: boolean;
    blockedCommands: string[];
  };
}

/**
 * Guardrails Configuration
 */
interface GuardrailsConfig {
  enabled: boolean;
  mode: 'strict' | 'moderate' | 'permissive';
  approvalRequired: boolean;
  autoApproveLevel: 'safe' | 'low' | 'medium' | 'never';
  rules: {
    blockDestructiveCommands: boolean;
    requireConfirmationForHighRisk: boolean;
    validateTargetScope: boolean;
    preventDataExfiltration: boolean;
    limitResourceUsage: boolean;
  };
  customRules: string[];
  notifications: {
    alertOnBlocked: boolean;
    alertOnApprovalNeeded: boolean;
    emailNotifications: boolean;
    slackWebhook?: string;
  };
}

/**
 * Online Research Configuration
 */
interface OnlineResearchConfig {
  enabled: boolean;
  providers: {
    hacktricks: boolean;
    perplexity: boolean;
    shodan: boolean;
    cve: boolean;
    exploit_db: boolean;
  };
  apiKeys: {
    perplexityKey?: string;
    shodanKey?: string;
  };
  researchDepth: 'basic' | 'comprehensive' | 'deep';
  autoResearch: boolean;
  researchTriggers: string[];
}

/**
 * AI Agent/LLM configuration interface
 */
interface AIAgentConfiguration {
  model: string;
  fallbackModel: string;
  temperature: number;
  maxTokens: number;
  systemPrompt: string;
  enableReasoningMode: boolean;
  reasoningModel: string;
  customInstructions: string;
  responseFormat: 'json' | 'text' | 'structured';
  safetyLevel: 'low' | 'medium' | 'high';
  contextWindow: number;
  streamingEnabled: boolean;
  // Automation modes
  automationMode: 'fully_automatic' | 'human_approval' | 'manual';
  approvalThreshold: 'low' | 'medium' | 'high' | 'critical';
  // Local model configuration
  useLocalModel: boolean;
  localModelConfig: {
    apiEndpoint: string;
    port: number;
    modelName: string;
    apiKey?: string;
    timeout: number;
    maxRetries: number;
    provider: 'ollama' | 'lm-studio' | 'text-generation-webui' | 'custom';
  };
  // Kali MCP Server integration
  kaliMCPServer: KaliMCPServerConfig;
  // Guardrails configuration
  guardrails: GuardrailsConfig;
  // Online research configuration
  onlineResearch: OnlineResearchConfig;
  // HackTricks integration
  hackTricksIntegration: {
    enabled: boolean;
    autoLoadMethodology: boolean;
    preferredCategories: string[];
    updateFrequency: 'real-time' | 'daily' | 'weekly';
  };
  // System prompt presets
  systemPromptPreset: string;
  customSystemPrompts: Record<string, string>;
}

/**
 * Overall pentest configuration state
 */
interface PentestConfiguration {
  modules: PentestModule[];
  aiAgent: AIAgentConfiguration;
  globalSettings: {
    aggressionLevel: number;
    timeout: number;
    retries: number;
    concurrency: number;
    stealth: boolean;
    automated: boolean;
    reportingLevel: 'minimal' | 'standard' | 'comprehensive';
  };
  metadata: {
    name: string;
    description: string;
    target: string;
    scope: string;
    created: string;
    modified: string;
    ipRanges?: string;
    portRanges?: string;
    scanTechnique?: 'syn' | 'tcp' | 'udp' | 'ack' | 'comprehensive';
    aggressiveTiming?: boolean;
    serviceDetection?: boolean;
    osDetection?: boolean;
  };
}

// ===========================
// COMPONENT PROPS
// ===========================

interface EnhancedAgenticPentestInterfaceProps {
  onClose: () => void;
  onConfigurationChange?: (config: PentestConfiguration) => void;
  initialConfiguration?: Partial<PentestConfiguration>;
}

// ===========================
// MAIN COMPONENT
// ===========================

export const EnhancedAgenticPentestInterface: React.FC<EnhancedAgenticPentestInterfaceProps> = ({
  onClose,
  onConfigurationChange,
  initialConfiguration
}) => {
  // ===========================
  // STATE MANAGEMENT
  // ===========================

  const [configuration, setConfiguration] = useState<PentestConfiguration>({
    modules: [],
    aiAgent: {
      model: 'gpt-5-2025-08-07',
      fallbackModel: 'gpt-4.1-2025-04-14',
      temperature: 0.2,
      maxTokens: 2000,
      systemPrompt: 'You are an expert AI cybersecurity agent specializing in penetration testing and vulnerability assessment. Provide detailed, actionable insights while maintaining ethical and legal compliance.',
      enableReasoningMode: false,
      reasoningModel: 'o4-mini-2025-04-16',
      customInstructions: '',
      responseFormat: 'structured',
      safetyLevel: 'high',
      contextWindow: 200000,
      streamingEnabled: true,
      automationMode: 'human_approval',
      approvalThreshold: 'medium',
      useLocalModel: false,
      localModelConfig: {
        apiEndpoint: 'http://localhost',
        port: 11434,
        modelName: 'llama2',
        timeout: 30000,
        maxRetries: 3,
        provider: 'ollama'
      },
      kaliMCPServer: {
        enabled: false,
        serverEndpoint: 'http://kali-mcp-server.local',
        port: 8080,
        timeout: 60000,
        maxRetries: 3,
        enabledTools: ['nmap', 'sqlmap', 'nikto', 'gobuster', 'nuclei'],
        resourceLimits: {
          maxConcurrentJobs: 5,
          maxMemoryUsage: '2GB',
          maxExecutionTime: 3600
        },
        securitySettings: {
          sandboxMode: true,
          allowNetworkAccess: true,
          allowSystemCommands: false,
          blockedCommands: ['rm -rf', 'dd', 'mkfs', 'fdisk']
        }
      },
      guardrails: {
        enabled: true,
        mode: 'moderate',
        approvalRequired: true,
        autoApproveLevel: 'safe',
        rules: {
          blockDestructiveCommands: true,
          requireConfirmationForHighRisk: true,
          validateTargetScope: true,
          preventDataExfiltration: true,
          limitResourceUsage: true
        },
        customRules: [],
        notifications: {
          alertOnBlocked: true,
          alertOnApprovalNeeded: true,
          emailNotifications: false
        }
      },
      onlineResearch: {
        enabled: true,
        providers: {
          hacktricks: true,
          perplexity: true,
          shodan: false,
          cve: true,
          exploit_db: true
        },
        apiKeys: {},
        researchDepth: 'comprehensive',
        autoResearch: true,
        researchTriggers: ['vulnerability_found', 'new_target', 'exploitation_failed']
      },
      hackTricksIntegration: {
        enabled: true,
        autoLoadMethodology: true,
        preferredCategories: ['web', 'network', 'active-directory', 'kubernetes'],
        updateFrequency: 'daily'
      },
      systemPromptPreset: 'pentest-expert',
      customSystemPrompts: {
        'pentest-expert': 'You are an expert AI cybersecurity agent specializing in penetration testing and vulnerability assessment. Provide detailed, actionable insights while maintaining ethical and legal compliance.',
        'red-team': 'You are an advanced red team operator with deep expertise in offensive security. Focus on creative attack vectors while ensuring all activities remain within legal boundaries.',
        'compliance-focused': 'You are a cybersecurity compliance expert conducting authorized security assessments. Prioritize documentation, risk classification, and regulatory alignment in all analyses.',
        'beginner-friendly': 'You are a patient cybersecurity mentor helping newcomers learn penetration testing. Explain concepts clearly, provide educational context, and emphasize safety practices.'
      }
    },
    globalSettings: {
      aggressionLevel: 3,
      timeout: 300,
      retries: 3,
      concurrency: 5,
      stealth: true,
      automated: false,
      reportingLevel: 'standard'
    },
    metadata: {
      name: 'New Pentest Configuration',
      description: '',
      target: '',
      scope: '',
      created: new Date().toISOString(),
      modified: new Date().toISOString(),
      ipRanges: '',
      portRanges: '1-1000',
      scanTechnique: 'syn',
      aggressiveTiming: false,
      serviceDetection: true,
      osDetection: false
    }
  });

  const [isRunning, setIsRunning] = useState(false);
  const [activeLeftTab, setActiveLeftTab] = useState('modules');
  const [activeRightTab, setActiveRightTab] = useState('ai-agent');
  const [isShellOpen, setIsShellOpen] = useState(false);
  const [currentSessionId, setCurrentSessionId] = useState<string | null>(null);
  const { hasUnreadEntries, markAsRead } = useLLMShell({ 
    sessionId: currentSessionId, 
    enableMockData: true 
  });

  // ===========================
  // DEFAULT DATA INITIALIZATION
  // ===========================

  /**
   * Initialize default penetration testing modules
   */
  const initializeDefaultModules = useCallback((): PentestModule[] => [
    {
      id: 'recon-passive',
      name: 'Passive Reconnaissance',
      description: 'Gather information without directly interacting with the target',
      category: 'reconnaissance',
      enabled: true,
      priority: 1,
      estimatedTime: '15-30 min',
      requiredTools: ['subfinder', 'amass', 'shodan'],
      riskLevel: 'low'
    },
    {
      id: 'recon-active',
      name: 'Active Reconnaissance',
      description: 'Direct interaction with target systems for information gathering',
      category: 'reconnaissance',
      enabled: true,
      priority: 2,
      estimatedTime: '30-60 min',
      requiredTools: ['nmap', 'masscan', 'gobuster'],
      riskLevel: 'medium'
    },
    {
      id: 'vuln-scan',
      name: 'Vulnerability Scanning',
      description: 'Automated vulnerability detection and assessment',
      category: 'vulnerability-assessment',
      enabled: true,
      priority: 3,
      estimatedTime: '45-90 min',
      requiredTools: ['nuclei', 'nikto', 'openvas'],
      riskLevel: 'medium'
    },
    {
      id: 'web-exploit',
      name: 'Web Application Exploitation',
      description: 'Test web applications for security vulnerabilities',
      category: 'exploitation',
      enabled: false,
      priority: 4,
      estimatedTime: '60-120 min',
      requiredTools: ['burp', 'sqlmap', 'ffuf'],
      riskLevel: 'high',
      prerequisites: ['vuln-scan']
    },
    {
      id: 'ad-exploit',
      name: 'Active Directory Exploitation',
      description: 'Target Active Directory environments for privilege escalation',
      category: 'exploitation',
      enabled: false,
      priority: 5,
      estimatedTime: '90-180 min',
      requiredTools: ['bloodhound', 'crackmapexec', 'mimikatz'],
      riskLevel: 'critical',
      prerequisites: ['recon-active']
    },
    {
      id: 'post-exploit',
      name: 'Post-Exploitation',
      description: 'Maintain access and gather additional intelligence',
      category: 'post-exploitation',
      enabled: false,
      priority: 6,
      estimatedTime: '60-120 min',
      requiredTools: ['metasploit', 'cobalt-strike', 'empire'],
      riskLevel: 'critical',
      prerequisites: ['web-exploit', 'ad-exploit']
    }
  ], []);

  // Removed: initializeDefaultScenarios, initializeDefaultFrameworks, initializeDefaultTools functions

  // Removed: initializeDefaultFrameworks function

  // ===========================
  // EFFECT HOOKS
  // ===========================

  /**
   * Initialize component with default data and merge with initial configuration
   */
  useEffect(() => {
    const defaultConfig: PentestConfiguration = {
      modules: initializeDefaultModules(),
      aiAgent: {
        model: 'gpt-5-2025-08-07',
        fallbackModel: 'gpt-4.1-2025-04-14',
        temperature: 0.2,
        maxTokens: 2000,
        systemPrompt: 'You are an expert AI cybersecurity agent specializing in penetration testing and vulnerability assessment. Provide detailed, actionable insights while maintaining ethical and legal compliance.',
        enableReasoningMode: false,
        reasoningModel: 'o4-mini-2025-04-16',
        customInstructions: '',
        responseFormat: 'structured',
        safetyLevel: 'high',
        contextWindow: 200000,
        streamingEnabled: true,
        automationMode: 'human_approval',
        approvalThreshold: 'medium',
        useLocalModel: false,
        localModelConfig: {
          apiEndpoint: 'http://localhost',
          port: 11434,
          modelName: 'llama2',
          timeout: 30000,
          maxRetries: 3,
          provider: 'ollama'
        },
        kaliMCPServer: {
          enabled: false,
          serverEndpoint: 'http://kali-mcp-server.local',
          port: 8080,
          timeout: 60000,
          maxRetries: 3,
          enabledTools: ['nmap', 'sqlmap', 'nikto', 'gobuster', 'nuclei'],
          resourceLimits: {
            maxConcurrentJobs: 5,
            maxMemoryUsage: '2GB',
            maxExecutionTime: 3600
          },
          securitySettings: {
            sandboxMode: true,
            allowNetworkAccess: true,
            allowSystemCommands: false,
            blockedCommands: ['rm -rf', 'dd', 'mkfs', 'fdisk']
          }
        },
        guardrails: {
          enabled: true,
          mode: 'moderate',
          approvalRequired: true,
          autoApproveLevel: 'safe',
          rules: {
            blockDestructiveCommands: true,
            requireConfirmationForHighRisk: true,
            validateTargetScope: true,
            preventDataExfiltration: true,
            limitResourceUsage: true
          },
          customRules: [],
          notifications: {
            alertOnBlocked: true,
            alertOnApprovalNeeded: true,
            emailNotifications: false
          }
        },
        onlineResearch: {
          enabled: true,
          providers: {
            hacktricks: true,
            perplexity: true,
            shodan: false,
            cve: true,
            exploit_db: true
          },
          apiKeys: {},
          researchDepth: 'comprehensive',
          autoResearch: true,
          researchTriggers: ['vulnerability_found', 'new_target', 'exploitation_failed']
        },
        hackTricksIntegration: {
          enabled: true,
          autoLoadMethodology: true,
          preferredCategories: ['web', 'network', 'active-directory', 'kubernetes'],
          updateFrequency: 'daily'
        },
        systemPromptPreset: 'pentest-expert',
        customSystemPrompts: {
          'pentest-expert': 'You are an expert AI cybersecurity agent specializing in penetration testing and vulnerability assessment. Provide detailed, actionable insights while maintaining ethical and legal compliance.',
          'red-team': 'You are an advanced red team operator with deep expertise in offensive security. Focus on creative attack vectors while ensuring all activities remain within legal boundaries.',
          'compliance-focused': 'You are a cybersecurity compliance expert conducting authorized security assessments. Prioritize documentation, risk classification, and regulatory alignment in all analyses.',
          'beginner-friendly': 'You are a patient cybersecurity mentor helping newcomers learn penetration testing. Explain concepts clearly, provide educational context, and emphasize safety practices.'
        }
      },
      globalSettings: {
        aggressionLevel: 3,
        timeout: 300,
        retries: 3,
        concurrency: 5,
        stealth: true,
        automated: false,
        reportingLevel: 'standard'
      },
      metadata: {
        name: 'New Pentest Configuration',
        description: '',
        target: '',
        scope: '',
        created: new Date().toISOString(),
        modified: new Date().toISOString()
      }
    };

    // Merge with initial configuration if provided
    if (initialConfiguration) {
      const mergedConfig = { ...defaultConfig, ...initialConfiguration };
      setConfiguration(mergedConfig);
    } else {
      setConfiguration(defaultConfig);
    }
  }, [initializeDefaultModules, initialConfiguration]);

  /**
   * Notify parent component of configuration changes
   */
  useEffect(() => {
    if (onConfigurationChange) {
      onConfigurationChange(configuration);
    }
  }, [configuration, onConfigurationChange]);

  // ===========================
  // EVENT HANDLERS
  // ===========================

  /**
   * Toggle module enabled state
   */
  const toggleModule = useCallback((moduleId: string) => {
    setConfiguration(prev => ({
      ...prev,
      modules: prev.modules.map(module =>
        module.id === moduleId ? { ...module, enabled: !module.enabled } : module
      ),
      metadata: { ...prev.metadata, modified: new Date().toISOString() }
    }));
  }, []);

  // Removed: toggleScenario, toggleScenarioPhase, toggleFramework, toggleTool, updateToolAggression functions

  /**
   * Update global settings
   */
  const updateGlobalSettings = useCallback((key: keyof PentestConfiguration['globalSettings'], value: any) => {
    setConfiguration(prev => ({
      ...prev,
      globalSettings: { ...prev.globalSettings, [key]: value },
      metadata: { ...prev.metadata, modified: new Date().toISOString() }
    }));
  }, []);

  /**
   * Update AI Agent configuration
   */
  const updateAIAgentConfig = useCallback((key: keyof AIAgentConfiguration, value: any) => {
    setConfiguration(prev => ({
      ...prev,
      aiAgent: { ...prev.aiAgent, [key]: value },
      metadata: { ...prev.metadata, modified: new Date().toISOString() }
    }));
  }, []);

  /**
   * Test AI Agent connection
   */
  const testAIAgent = useCallback(async () => {
    const endpoint = configuration.aiAgent.useLocalModel 
      ? `${configuration.aiAgent.localModelConfig.apiEndpoint}:${configuration.aiAgent.localModelConfig.port}`
      : configuration.aiAgent.model;
      
    toast({
      title: "Testing AI Agent",
      description: `Testing connection to ${endpoint}...`,
    });

    // Mock test - in production, make actual API call
    setTimeout(() => {
      toast({
        title: "AI Agent Test",
        description: configuration.aiAgent.useLocalModel
          ? `Local model ${configuration.aiAgent.localModelConfig.modelName} is ready`
          : `${configuration.aiAgent.model} is ready for penetration testing`,
      });
    }, 2000);
  }, [configuration.aiAgent]);

  /**
   * Update local model configuration
   */
  const updateLocalModelConfig = useCallback((key: keyof AIAgentConfiguration['localModelConfig'], value: any) => {
    setConfiguration(prev => ({
      ...prev,
      aiAgent: { 
        ...prev.aiAgent, 
        localModelConfig: { ...prev.aiAgent.localModelConfig, [key]: value }
      },
      metadata: { ...prev.metadata, modified: new Date().toISOString() }
    }));
  }, []);

  /**
   * Handle system prompt preset selection
   */
  const handleSystemPromptPreset = useCallback((presetId: string) => {
    const preset = configuration.aiAgent.customSystemPrompts[presetId];
    if (preset) {
      setConfiguration(prev => ({
        ...prev,
        aiAgent: {
          ...prev.aiAgent,
          systemPromptPreset: presetId,
          systemPrompt: preset
        },
        metadata: { ...prev.metadata, modified: new Date().toISOString() }
      }));
    }
  }, [configuration.aiAgent.customSystemPrompts]);

  /**
   * Save custom system prompt
   */
  const saveCustomSystemPrompt = useCallback((name: string, prompt: string) => {
    if (!name.trim() || !prompt.trim()) {
      toast({
        title: "Invalid Input",
        description: "Please provide both name and prompt content",
        variant: "destructive"
      });
      return;
    }

    setConfiguration(prev => ({
      ...prev,
      aiAgent: {
        ...prev.aiAgent,
        customSystemPrompts: {
          ...prev.aiAgent.customSystemPrompts,
          [name]: prompt
        }
      },
      metadata: { ...prev.metadata, modified: new Date().toISOString() }
    }));

    toast({
      title: "Prompt Saved",
      description: `Custom prompt "${name}" has been saved successfully`,
    });
  }, []);

  // State for prompt management dialog
  const [showPromptManager, setShowPromptManager] = useState(false);
  const [newPromptName, setNewPromptName] = useState('');
  const [newPromptContent, setNewPromptContent] = useState('');

  /**
   * Get prompt behavior description for UI
   */
  const getPromptBehaviorDescription = (promptKey: string): string => {
    const descriptions: Record<string, string> = {
      'pentest-expert': 'Professional, detailed analysis with compliance focus',
      'red-team': 'Creative attack vectors with advanced tactics',
      'compliance-focused': 'Regulatory alignment and documentation emphasis',
      'beginner-friendly': 'Educational explanations with safety emphasis'
    };
    return descriptions[promptKey] || 'Custom behavior as defined in prompt';
  };

  /**
   * Export configuration to JSON
   */
  const exportConfiguration = useCallback(() => {
    try {
      const dataStr = JSON.stringify(configuration, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `pentest-config-${new Date().toISOString().split('T')[0]}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
      
      toast({
        title: "Configuration Exported",
        description: "Configuration has been exported successfully",
      });
    } catch (error) {
      toast({
        title: "Export Failed",
        description: "Failed to export configuration",
        variant: "destructive"
      });
    }
  }, [configuration]);

  /**
   * Start penetration test execution
   */
  const startPentest = useCallback(() => {
    const enabledModules = configuration.modules.filter(m => m.enabled);
    
    if (enabledModules.length === 0) {
      toast({
        title: "No Modules Selected",
        description: "Please select at least one module to run",
        variant: "destructive"
      });
      return;
    }
    
    setIsRunning(true);
    toast({
      title: "Pentest Started",
      description: `Starting penetration test with ${enabledModules.length} modules`,
    });
    
    // Simulate pentest execution (replace with actual backend call)
    setTimeout(() => {
      setIsRunning(false);
      toast({
        title: "Pentest Completed",
        description: "Penetration test has completed successfully",
      });
    }, 5000);
  }, [configuration]);

  // ===========================
  // UTILITY FUNCTIONS
  // ===========================

  /**
   * Handle session start
   */
  const handleStartSession = useCallback(() => {
    setIsRunning(true);
    setCurrentSessionId(`session-${Date.now()}`);
    toast({
      title: "Session Started",
      description: "LLM reasoning shell is now active and collecting data.",
    });
  }, []);

  /**
   * Handle session stop
   */
  const handleStopSession = useCallback(() => {
    setIsRunning(false);
    toast({
      title: "Session Stopped",
      description: "Pentest session has been terminated.",
    });
  }, []);

  /**
   * Handle shell toggle
   */
  const handleShellToggle = useCallback(() => {
    setIsShellOpen(!isShellOpen);
    if (!isShellOpen) {
      markAsRead();
    }
  }, [isShellOpen, markAsRead]);

  /**
   * Get category icon for tools and modules
   */
  const getCategoryIcon = (category: string) => {
    const iconMap: Record<string, React.ComponentType<any>> = {
      network: Network,
      web: Globe,
      ad: Lock,
      osint: Search,
      mobile: Target,
      cloud: Database,
      social: Bot,
      reconnaissance: Eye,
      'vulnerability-assessment': Shield,
      exploitation: Target,
      'post-exploitation': Terminal,
      reporting: FileText
    };
    
    const IconComponent = iconMap[category] || Terminal;
    return <IconComponent className="w-4 h-4" />;
  };

  /**
   * Get risk level badge variant
   */
  const getRiskBadgeVariant = (risk: string) => {
    switch (risk) {
      case 'low': return 'secondary';
      case 'medium': return 'default';
      case 'high': return 'destructive';
      case 'critical': return 'destructive';
      default: return 'secondary';
    }
  };

  // ===========================
  // RENDER COMPONENT
  // ===========================

  return (
    <div className="flex flex-col w-full">
      {/* LLM Shell Toggle Button */}
      {isRunning && (
        <ShellToggleButton
          isOpen={isShellOpen}
          onClick={handleShellToggle}
          hasNewEntries={hasUnreadEntries}
        />
      )}

      {/* LLM Shell Overlay */}
      <Sheet open={isShellOpen} onOpenChange={setIsShellOpen}>
        <SheetContent 
          side="right" 
          className="w-[600px] sm:w-[700px] p-0 bg-gray-950 border-l border-gray-800"
        >
          <LLMReasoningShell 
            sessionId={currentSessionId} 
            enableMockData={true} 
          />
        </SheetContent>
      </Sheet>

      {/* Header */}
      <div className="flex items-center justify-between p-4 border-b bg-muted/30 flex-shrink-0">
        <div className="flex items-center gap-3">
          <div className="flex items-center justify-center w-10 h-10 rounded-lg bg-primary/10">
            <Shield className="w-5 h-5 text-primary" />
          </div>
          <div>
            <h2 className="text-xl font-bold">Enhanced Agentic Pentest Interface</h2>
            <p className="text-sm text-muted-foreground">Production-ready penetration testing configuration</p>
          </div>
        </div>
        
        <div className="flex items-center gap-2">
          <Button
            variant="outline"
            size="sm"
            onClick={exportConfiguration}
            className="flex items-center gap-2"
          >
            <Download className="w-4 h-4" />
            Export
          </Button>
          
          <Button
            onClick={() => {
              if (isRunning) {
                handleStopSession();
              } else {
                startPentest();
                handleStartSession();
              }
            }}
            disabled={isRunning}
            className="flex items-center gap-2"
          >
            {isRunning ? (
              <>
                <Pause className="w-4 h-4" />
                Running...
              </>
            ) : (
              <>
                <Play className="w-4 h-4" />
                Start Pentest
              </>
            )}
          </Button>
        </div>
      </div>

      {/* Main Content */}
      <div className="flex flex-1 overflow-hidden">
        {/* Left Panel - Module Configuration */}
        <div className="w-1/2 border-r flex flex-col">
          <div className="p-4 border-b bg-muted/20">
            <h3 className="font-semibold flex items-center gap-2">
              <Settings className="w-4 h-4" />
              Module Configuration
            </h3>
            <p className="text-sm text-muted-foreground mt-1">
              Configure and enable penetration testing modules
            </p>
          </div>
          
          <Tabs value={activeLeftTab} onValueChange={setActiveLeftTab} className="flex-1 flex flex-col">
            <div className="px-4 pt-2 border-b">
              <TabsList className="grid grid-cols-2 w-full">
                <TabsTrigger value="modules">Modules</TabsTrigger>
                <TabsTrigger value="metadata">Metadata</TabsTrigger>
              </TabsList>
            </div>
            
            <ScrollArea className="flex-1 h-full">
              <div className="p-4">
                <TabsContent value="modules" className="space-y-4 mt-0">
                {configuration.modules.map((module) => (
                  <Card key={module.id} className={`transition-all ${
                    module.enabled 
                      ? 'bg-primary/5 border-primary/30 shadow-sm' 
                      : 'bg-muted/20 border-border/50'
                  }`}>
                    <CardContent className="pt-4">
                      <div className="flex items-start justify-between mb-3">
                        <div className="flex items-start gap-3 flex-1">
                          <div className="flex-shrink-0 mt-1">
                            {getCategoryIcon(module.category)}
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-1">
                              <h4 className="font-semibold text-sm">{module.name}</h4>
                              <Badge variant={getRiskBadgeVariant(module.riskLevel)} className="text-xs">
                                {module.riskLevel}
                              </Badge>
                            </div>
                            <p className="text-xs text-muted-foreground mb-2 line-clamp-2">
                              {module.description}
                            </p>
                            <div className="flex items-center gap-3 text-xs text-muted-foreground">
                              <div className="flex items-center gap-1">
                                <Clock className="w-3 h-3" />
                                {module.estimatedTime}
                              </div>
                              <div className="flex items-center gap-1">
                                <TrendingUp className="w-3 h-3" />
                                Priority {module.priority}
                              </div>
                            </div>
                          </div>
                        </div>
                        <Switch
                          checked={module.enabled}
                          onCheckedChange={() => toggleModule(module.id)}
                        />
                      </div>
                      
                      {module.enabled && (
                        <div className="mt-3 pt-3 border-t space-y-2">
                          <div className="text-xs">
                            <Label className="font-medium">Required Tools:</Label>
                            <div className="flex flex-wrap gap-1 mt-1">
                              {module.requiredTools.map((tool) => (
                                <Badge key={tool} variant="outline" className="text-xs">
                                  {tool}
                                </Badge>
                              ))}
                            </div>
                          </div>
                          
                          {module.prerequisites && (
                            <div className="text-xs">
                              <Label className="font-medium">Prerequisites:</Label>
                              <div className="flex flex-wrap gap-1 mt-1">
                                {module.prerequisites.map((prereq) => (
                                  <Badge key={prereq} variant="secondary" className="text-xs">
                                    {prereq}
                                  </Badge>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </CardContent>
                  </Card>
                ))}
              </TabsContent>
              
              <TabsContent value="metadata" className="space-y-4 mt-0">
                <Card>
                  <CardHeader>
                    <CardTitle className="text-base">Configuration Metadata</CardTitle>
                    <CardDescription>
                      Basic information about this penetration test configuration
                    </CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div>
                      <Label htmlFor="config-name">Configuration Name</Label>
                      <Input
                        id="config-name"
                        value={configuration.metadata.name}
                        onChange={(e) => setConfiguration(prev => ({
                          ...prev,
                          metadata: { ...prev.metadata, name: e.target.value, modified: new Date().toISOString() }
                        }))}
                        placeholder="Enter configuration name"
                      />
                    </div>
                    
                    <div>
                      <Label htmlFor="config-description">Description</Label>
                      <Textarea
                        id="config-description"
                        value={configuration.metadata.description}
                        onChange={(e) => setConfiguration(prev => ({
                          ...prev,
                          metadata: { ...prev.metadata, description: e.target.value, modified: new Date().toISOString() }
                        }))}
                        placeholder="Describe the purpose and scope of this configuration"
                        rows={3}
                      />
                    </div>
                    
                    <div>
                      <Label htmlFor="config-target">Target</Label>
                      <Input
                        id="config-target"
                        value={configuration.metadata.target}
                        onChange={(e) => setConfiguration(prev => ({
                          ...prev,
                          metadata: { ...prev.metadata, target: e.target.value, modified: new Date().toISOString() }
                        }))}
                        placeholder="Target system or domain"
                      />
                    </div>
                    
                    <div>
                      <Label htmlFor="config-scope">Scope</Label>
                      <Textarea
                        id="config-scope"
                        value={configuration.metadata.scope}
                        onChange={(e) => setConfiguration(prev => ({
                          ...prev,
                          metadata: { ...prev.metadata, scope: e.target.value, modified: new Date().toISOString() }
                        }))}
                        placeholder="Define the scope and boundaries of the test"
                        rows={2}
                      />
                    </div>
                  </CardContent>
                </Card>

                <Card>
                  <CardHeader>
                    <CardTitle className="text-base flex items-center gap-2">
                      <Target className="w-4 h-4" />
                      Target Configuration
                    </CardTitle>
                    <CardDescription>
                      Configure IP ranges, port ranges, and target specifications for network scanning
                    </CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div>
                      <Label htmlFor="ip-ranges">IP Ranges</Label>
                      <Textarea
                        id="ip-ranges"
                        value={configuration.metadata.ipRanges || ''}
                        onChange={(e) => setConfiguration(prev => ({
                          ...prev,
                          metadata: { ...prev.metadata, ipRanges: e.target.value, modified: new Date().toISOString() }
                        }))}
                        placeholder="192.168.1.0/24&#10;10.0.0.1-10.0.0.100&#10;172.16.0.1"
                        rows={3}
                        className="font-mono text-sm"
                      />
                      <p className="text-xs text-muted-foreground mt-1">
                        Enter IP ranges in CIDR notation (192.168.1.0/24), range format (10.0.0.1-10.0.0.100), or individual IPs. One per line.
                      </p>
                    </div>
                    
                    <div>
                      <Label htmlFor="port-ranges">Port Ranges</Label>
                      <Input
                        id="port-ranges"
                        value={configuration.metadata.portRanges || ''}
                        onChange={(e) => setConfiguration(prev => ({
                          ...prev,
                          metadata: { ...prev.metadata, portRanges: e.target.value, modified: new Date().toISOString() }
                        }))}
                        placeholder="1-65535, 80,443,8080, 22-25"
                        className="font-mono text-sm"
                      />
                      <p className="text-xs text-muted-foreground mt-1">
                        Enter port ranges (1-1000), individual ports (80,443), or combinations. Default: top 1000 ports.
                      </p>
                    </div>

                    <div className="flex gap-2">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setConfiguration(prev => ({
                          ...prev,
                          metadata: { 
                            ...prev.metadata, 
                            portRanges: '1-1000', 
                            modified: new Date().toISOString() 
                          }
                        }))}
                        className="text-xs"
                      >
                        Top 1000
                      </Button>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setConfiguration(prev => ({
                          ...prev,
                          metadata: { 
                            ...prev.metadata, 
                            portRanges: '80,443,8080,8443,22,21,23,25,53,110,995,993,143,587', 
                            modified: new Date().toISOString() 
                          }
                        }))}
                        className="text-xs"
                      >
                        Common Ports
                      </Button>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setConfiguration(prev => ({
                          ...prev,
                          metadata: { 
                            ...prev.metadata, 
                            portRanges: '1-65535', 
                            modified: new Date().toISOString() 
                          }
                        }))}
                        className="text-xs"
                      >
                        All Ports
                      </Button>
                    </div>

                    <div>
                      <Label htmlFor="scan-technique">Scan Technique</Label>
                      <Select
                        value={configuration.metadata.scanTechnique || 'syn'}
                        onValueChange={(value: any) => setConfiguration(prev => ({
                          ...prev,
                          metadata: { ...prev.metadata, scanTechnique: value, modified: new Date().toISOString() }
                        }))}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="syn">SYN Scan (-sS) - Fast, stealthy</SelectItem>
                          <SelectItem value="tcp">TCP Connect (-sT) - Reliable</SelectItem>
                          <SelectItem value="udp">UDP Scan (-sU) - UDP services</SelectItem>
                          <SelectItem value="ack">ACK Scan (-sA) - Firewall detection</SelectItem>
                          <SelectItem value="comprehensive">Comprehensive (-sS -sU) - TCP + UDP</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>

                    <div className="flex items-center justify-between">
                      <Label htmlFor="aggressive-timing" className="text-sm">Aggressive Timing (-T4)</Label>
                      <Switch
                        id="aggressive-timing"
                        checked={configuration.metadata.aggressiveTiming || false}
                        onCheckedChange={(checked) => setConfiguration(prev => ({
                          ...prev,
                          metadata: { ...prev.metadata, aggressiveTiming: checked, modified: new Date().toISOString() }
                        }))}
                      />
                    </div>

                    <div className="flex items-center justify-between">
                      <Label htmlFor="service-detection" className="text-sm">Service Detection (-sV)</Label>
                      <Switch
                        id="service-detection"
                        checked={configuration.metadata.serviceDetection || true}
                        onCheckedChange={(checked) => setConfiguration(prev => ({
                          ...prev,
                          metadata: { ...prev.metadata, serviceDetection: checked, modified: new Date().toISOString() }
                        }))}
                      />
                    </div>

                    <div className="flex items-center justify-between">
                      <Label htmlFor="os-detection" className="text-sm">OS Detection (-O)</Label>
                      <Switch
                        id="os-detection"
                        checked={configuration.metadata.osDetection || false}
                        onCheckedChange={(checked) => setConfiguration(prev => ({
                          ...prev,
                          metadata: { ...prev.metadata, osDetection: checked, modified: new Date().toISOString() }
                        }))}
                      />
                    </div>
                  </CardContent>
                </Card>
              </TabsContent>
              </div>
            </ScrollArea>
          </Tabs>
        </div>

        {/* Right Panel - Framework & Tool Configuration */}
        <div className="w-1/2 flex flex-col">
          <div className="p-4 border-b bg-muted/20">
            <h3 className="font-semibold flex items-center gap-2">
              <Settings className="w-4 h-4" />
              Framework & Tool Configuration
            </h3>
            <p className="text-sm text-muted-foreground mt-1">
              Select frameworks, configure tools, and set aggression levels
            </p>
          </div>
          
          <Tabs value={activeRightTab} onValueChange={setActiveRightTab} className="flex-1 flex flex-col">
            <div className="px-4 pt-2 border-b">
              <TabsList className="grid grid-cols-2 w-full">
                <TabsTrigger value="ai-agent">AI Agent</TabsTrigger>
                <TabsTrigger value="settings">Settings</TabsTrigger>
              </TabsList>
            </div>
            
            <ScrollArea className="flex-1 h-full">
              <div className="p-4">
              {/* AI Agent Configuration Tab */}
              <TabsContent value="ai-agent" className="space-y-4 mt-0">
                <Card>
                  <CardHeader>
                    <CardTitle className="text-base flex items-center gap-2">
                      <Bot className="w-4 h-4" />
                      AI Agent Configuration
                    </CardTitle>
                    <CardDescription>
                      Configure the AI agent that will orchestrate and analyze the penetration test
                    </CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    {/* Model Selection */}
                    <div className="space-y-3">
                      <div>
                        <Label htmlFor="primary-model">Primary AI Model</Label>
                        <div className="flex items-center gap-2 mb-2">
                          <Switch
                            checked={configuration.aiAgent.useLocalModel}
                            onCheckedChange={(checked) => updateAIAgentConfig('useLocalModel', checked)}
                          />
                          <Label className="text-sm">Use Local Model</Label>
                        </div>
                        
                        {configuration.aiAgent.useLocalModel ? (
                          <div className="space-y-3 p-3 border rounded-lg bg-muted/20">
                            <div className="grid grid-cols-2 gap-3">
                              <div>
                                <Label htmlFor="local-provider">Provider</Label>
                                <Select 
                                  value={configuration.aiAgent.localModelConfig.provider} 
                                  onValueChange={(value: any) => updateLocalModelConfig('provider', value)}
                                >
                                  <SelectTrigger>
                                    <SelectValue />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="ollama">
                                      <div className="flex items-center gap-2">
                                        <Badge variant="secondary" className="text-xs">Popular</Badge>
                                        Ollama
                                      </div>
                                    </SelectItem>
                                    <SelectItem value="lm-studio">LM Studio</SelectItem>
                                    <SelectItem value="text-generation-webui">Text Generation WebUI</SelectItem>
                                    <SelectItem value="custom">Custom API</SelectItem>
                                  </SelectContent>
                                </Select>
                              </div>
                              
                              <div>
                                <Label htmlFor="local-model-name">Model Name</Label>
                                <Input
                                  id="local-model-name"
                                  value={configuration.aiAgent.localModelConfig.modelName}
                                  onChange={(e) => updateLocalModelConfig('modelName', e.target.value)}
                                  placeholder="llama2, mistral-7b, etc."
                                />
                              </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-3">
                              <div>
                                <Label htmlFor="local-endpoint">API Endpoint</Label>
                                <Input
                                  id="local-endpoint"
                                  value={configuration.aiAgent.localModelConfig.apiEndpoint}
                                  onChange={(e) => updateLocalModelConfig('apiEndpoint', e.target.value)}
                                  placeholder="http://localhost"
                                />
                              </div>
                              
                              <div>
                                <Label htmlFor="local-port">Port</Label>
                                <Input
                                  id="local-port"
                                  type="number"
                                  value={configuration.aiAgent.localModelConfig.port}
                                  onChange={(e) => updateLocalModelConfig('port', parseInt(e.target.value) || 11434)}
                                  placeholder="11434"
                                />
                              </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-3">
                              <div>
                                <Label htmlFor="local-timeout">Timeout (ms)</Label>
                                <Input
                                  id="local-timeout"
                                  type="number"
                                  value={configuration.aiAgent.localModelConfig.timeout}
                                  onChange={(e) => updateLocalModelConfig('timeout', parseInt(e.target.value) || 30000)}
                                  placeholder="30000"
                                />
                              </div>
                              
                              <div>
                                <Label htmlFor="local-retries">Max Retries</Label>
                                <Input
                                  id="local-retries"
                                  type="number"
                                  value={configuration.aiAgent.localModelConfig.maxRetries}
                                  onChange={(e) => updateLocalModelConfig('maxRetries', parseInt(e.target.value) || 3)}
                                  min="1"
                                  max="10"
                                />
                              </div>
                            </div>
                            
                            {(configuration.aiAgent.localModelConfig.provider === 'custom' || 
                              configuration.aiAgent.localModelConfig.provider === 'text-generation-webui') && (
                              <div>
                                <Label htmlFor="local-api-key">API Key (Optional)</Label>
                                <Input
                                  id="local-api-key"
                                  type="password"
                                  value={configuration.aiAgent.localModelConfig.apiKey || ''}
                                  onChange={(e) => updateLocalModelConfig('apiKey', e.target.value)}
                                  placeholder="Optional authentication key"
                                />
                              </div>
                            )}
                            
                            <div className="flex items-center justify-between p-2 bg-blue-50 dark:bg-blue-950/30 rounded border border-blue-200 dark:border-blue-800">
                              <div className="text-sm">
                                <div className="font-medium">Endpoint Preview:</div>
                                <div className="text-muted-foreground">
                                  {configuration.aiAgent.localModelConfig.apiEndpoint}:{configuration.aiAgent.localModelConfig.port}
                                </div>
                              </div>
                              <Badge variant="outline" className="text-xs">
                                {configuration.aiAgent.localModelConfig.provider}
                              </Badge>
                            </div>
                          </div>
                        ) : (
                          <Select 
                            value={configuration.aiAgent.model} 
                            onValueChange={(value) => updateAIAgentConfig('model', value)}
                          >
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="gpt-5-2025-08-07">
                                <div className="flex items-center gap-2">
                                  <Badge variant="secondary" className="text-xs">Latest</Badge>
                                  GPT-5 (Flagship Model)
                                </div>
                              </SelectItem>
                              <SelectItem value="gpt-4.1-2025-04-14">GPT-4.1 (Reliable Performance)</SelectItem>
                              <SelectItem value="gpt-5-mini-2025-08-07">GPT-5 Mini (Fast & Efficient)</SelectItem>
                              <SelectItem value="claude-opus-4-20250514">
                                <div className="flex items-center gap-2">
                                  <Badge variant="outline" className="text-xs">Anthropic</Badge>
                                  Claude Opus 4 (Most Capable)
                                </div>
                              </SelectItem>
                              <SelectItem value="claude-sonnet-4-20250514">
                                <div className="flex items-center gap-2">
                                  <Badge variant="outline" className="text-xs">Anthropic</Badge>
                                  Claude Sonnet 4 (High Performance)
                                </div>
                              </SelectItem>
                              <SelectItem value="claude-3-5-haiku-20241022">Claude Haiku (Fastest Response)</SelectItem>
                            </SelectContent>
                          </Select>
                        )}
                        
                        <p className="text-xs text-muted-foreground mt-1">
                          {configuration.aiAgent.useLocalModel 
                            ? 'Configure your local AI model for enhanced privacy and control'
                            : 'Primary model for analysis, decision-making, and report generation'
                          }
                        </p>
                      </div>

                      <div>
                        <Label htmlFor="fallback-model">Fallback Model</Label>
                        <Select 
                          value={configuration.aiAgent.fallbackModel} 
                          onValueChange={(value) => updateAIAgentConfig('fallbackModel', value)}
                        >
                          <SelectTrigger>
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="gpt-4.1-2025-04-14">GPT-4.1 (Reliable)</SelectItem>
                            <SelectItem value="gpt-5-mini-2025-08-07">GPT-5 Mini (Fast)</SelectItem>
                            <SelectItem value="gpt-5-nano-2025-08-07">GPT-5 Nano (Fastest)</SelectItem>
                            <SelectItem value="claude-3-5-haiku-20241022">Claude Haiku (Quick)</SelectItem>
                          </SelectContent>
                        </Select>
                        <p className="text-xs text-muted-foreground mt-1">
                          Backup model used when primary model is unavailable
                        </p>
                      </div>
                    </div>

                    <Separator />

                    {/* Advanced Model Settings */}
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <div>
                          <Label>Enable Reasoning Mode</Label>
                          <p className="text-xs text-muted-foreground">Use specialized reasoning models for complex analysis</p>
                        </div>
                        <Switch
                          checked={configuration.aiAgent.enableReasoningMode}
                          onCheckedChange={(checked) => updateAIAgentConfig('enableReasoningMode', checked)}
                        />
                      </div>

                      {configuration.aiAgent.enableReasoningMode && (
                        <div>
                          <Label htmlFor="reasoning-model">Reasoning Model</Label>
                          <Select 
                            value={configuration.aiAgent.reasoningModel} 
                            onValueChange={(value) => updateAIAgentConfig('reasoningModel', value)}
                          >
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="o3-2025-04-16">
                                <div className="flex items-center gap-2">
                                  <Badge variant="destructive" className="text-xs">Pro</Badge>
                                  O3 (Most Powerful Reasoning)
                                </div>
                              </SelectItem>
                              <SelectItem value="o4-mini-2025-04-16">O4 Mini (Fast Reasoning)</SelectItem>
                            </SelectContent>
                          </Select>
                          <p className="text-xs text-muted-foreground mt-1">
                            Specialized model for multi-step analysis and complex problem-solving
                          </p>
                        </div>
                      )}

                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <Label>Temperature: {configuration.aiAgent.temperature}</Label>
                          <Slider
                            value={[configuration.aiAgent.temperature]}
                            onValueChange={([value]) => updateAIAgentConfig('temperature', parseFloat(value.toFixed(1)))}
                            max={1}
                            min={0}
                            step={0.1}
                            className="w-full mt-2"
                          />
                          <div className="flex justify-between text-xs text-muted-foreground mt-1">
                            <span>Focused</span>
                            <span>Creative</span>
                          </div>
                        </div>
                        
                        <div>
                          <Label htmlFor="max-tokens">Max Tokens</Label>
                          <Input
                            id="max-tokens"
                            type="number"
                            value={configuration.aiAgent.maxTokens}
                            onChange={(e) => updateAIAgentConfig('maxTokens', parseInt(e.target.value) || 2000)}
                            min={100}
                            max={8000}
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <Label htmlFor="response-format">Response Format</Label>
                          <Select 
                            value={configuration.aiAgent.responseFormat} 
                            onValueChange={(value) => updateAIAgentConfig('responseFormat', value)}
                          >
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="structured">Structured (Recommended)</SelectItem>
                              <SelectItem value="json">JSON</SelectItem>
                              <SelectItem value="text">Plain Text</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>

                        <div>
                          <Label htmlFor="safety-level">Safety Level</Label>
                          <Select 
                            value={configuration.aiAgent.safetyLevel} 
                            onValueChange={(value) => updateAIAgentConfig('safetyLevel', value)}
                          >
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                               <SelectItem value="high">
                                 <div className="flex items-center gap-2">
                                   <CheckCircle className="w-3 h-3 text-primary" />
                                   <span className="text-sm">High (Security Professionals)</span>
                                   <Badge variant="outline" className="ml-auto text-xs">
                                     Requires Experience
                                   </Badge>
                                 </div>
                               </SelectItem>
                               <SelectItem value="medium">
                                 <div className="flex items-center gap-2 p-2 rounded-md bg-muted/20">
                                   <AlertTriangle className="w-3 h-3 text-accent" />
                                   <span className="text-sm">Medium (Intermediate Users)</span>
                                 </div>
                               </SelectItem>
                               <SelectItem value="low">
                                 <div className="flex items-center gap-2 p-2 rounded-md bg-muted/20">
                                   <AlertTriangle className="w-3 h-3 text-accent" />
                                  Low (Advanced Users)
                                </div>
                              </SelectItem>
                            </SelectContent>
                          </Select>
                        </div>
                      </div>

                      <div className="flex items-center justify-between">
                        <div>
                          <Label>Streaming Enabled</Label>
                          <p className="text-xs text-muted-foreground">Real-time response streaming for better UX</p>
                        </div>
                        <Switch
                          checked={configuration.aiAgent.streamingEnabled}
                          onCheckedChange={(checked) => updateAIAgentConfig('streamingEnabled', checked)}
                        />
                      </div>
                    </div>

                    <Separator />

                    {/* System Prompt Configuration */}
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <Label htmlFor="system-prompt">System Prompt Configuration</Label>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => setShowPromptManager(true)}
                          className="flex items-center gap-2"
                        >
                          <Settings className="w-3 h-3" />
                          Manage Prompts
                        </Button>
                      </div>

                      <div>
                        <Label htmlFor="prompt-preset">System Prompt Preset</Label>
                        <Select 
                          value={configuration.aiAgent.systemPromptPreset} 
                          onValueChange={handleSystemPromptPreset}
                        >
                          <SelectTrigger>
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="pentest-expert">
                              <div className="space-y-1">
                                <div className="font-medium">Penetration Testing Expert</div>
                                <div className="text-xs text-muted-foreground">Professional security assessment focus</div>
                              </div>
                            </SelectItem>
                            <SelectItem value="red-team">
                              <div className="space-y-1">
                                <div className="font-medium">Red Team Operator</div>
                                <div className="text-xs text-muted-foreground">Advanced offensive security tactics</div>
                              </div>
                            </SelectItem>
                            <SelectItem value="compliance-focused">
                              <div className="space-y-1">
                                <div className="font-medium">Compliance Expert</div>
                                <div className="text-xs text-muted-foreground">Regulatory and compliance alignment</div>
                              </div>
                            </SelectItem>
                            <SelectItem value="beginner-friendly">
                              <div className="space-y-1">
                                <div className="font-medium">Security Mentor</div>
                                <div className="text-xs text-muted-foreground">Educational and learning-focused</div>
                              </div>
                            </SelectItem>
                            {Object.keys(configuration.aiAgent.customSystemPrompts).filter(key => 
                              !['pentest-expert', 'red-team', 'compliance-focused', 'beginner-friendly'].includes(key)
                            ).map(key => (
                              <SelectItem key={key} value={key}>
                                <div className="space-y-1">
                                  <div className="font-medium">{key}</div>
                                  <div className="text-xs text-muted-foreground">Custom prompt</div>
                                </div>
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                        <p className="text-xs text-muted-foreground mt-1">
                          Choose a pre-configured prompt or create your own
                        </p>
                      </div>

                      <div>
                        <Label htmlFor="system-prompt">Current System Prompt</Label>
                        <Textarea
                          id="system-prompt"
                          value={configuration.aiAgent.systemPrompt}
                          onChange={(e) => updateAIAgentConfig('systemPrompt', e.target.value)}
                          placeholder="Define the AI agent's role and behavior..."
                          rows={6}
                          className="text-sm"
                        />
                        <div className="flex items-center justify-between mt-1">
                          <p className="text-xs text-muted-foreground">
                            Core instructions that define the AI agent's expertise and behavior
                          </p>
                          <Badge variant="outline" className="text-xs">
                            {configuration.aiAgent.systemPrompt.length} characters
                          </Badge>
                        </div>
                      </div>

                      <div>
                        <Label htmlFor="custom-instructions">Additional Instructions (Context-Specific)</Label>
                        <Textarea
                          id="custom-instructions"
                          value={configuration.aiAgent.customInstructions}
                          onChange={(e) => updateAIAgentConfig('customInstructions', e.target.value)}
                          placeholder="Additional specific instructions for this pentest configuration..."
                          rows={3}
                          className="text-sm"
                        />
                        <p className="text-xs text-muted-foreground mt-1">
                          Specific instructions that will be appended to the system prompt for this configuration
                        </p>
                      </div>
                    </div>

                    <Separator />

                    {/* Agent Test & Actions */}
                    <div className="flex items-center justify-between">
                      <div>
                        <Label>AI Agent Status</Label>
                        <p className="text-xs text-muted-foreground">
                          Current model: {configuration.aiAgent.model}
                          {configuration.aiAgent.enableReasoningMode && ` + ${configuration.aiAgent.reasoningModel}`}
                        </p>
                      </div>
                      <Button 
                        variant="outline" 
                        size="sm"
                        onClick={testAIAgent}
                        className="flex items-center gap-2"
                      >
                        <CheckCircle className="w-4 h-4" />
                        Test Agent
                      </Button>
                    </div>
                  </CardContent>
                </Card>

                {/* Automation & Guardrails Configuration */}
                <Card>
                  <CardHeader>
                    <CardTitle className="text-base flex items-center gap-2">
                      <Shield className="w-4 h-4" />
                      Automation & Guardrails
                    </CardTitle>
                    <CardDescription>
                      Configure automation modes and safety guardrails for the AI agent
                    </CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    {/* Automation Mode */}
                    <div>
                      <Label htmlFor="automation-mode">Automation Mode</Label>
                      <Select 
                        value={configuration.aiAgent.automationMode} 
                        onValueChange={(value: any) => updateAIAgentConfig('automationMode', value)}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="fully_automatic">
                            <div className="space-y-1">
                              <div className="flex items-center gap-2">
                                <Settings className="w-4 h-4" />
                                <span className="font-medium">Fully Automatic</span>
                              </div>
                              <div className="text-xs text-muted-foreground">AI executes all actions without human approval</div>
                            </div>
                          </SelectItem>
                          <SelectItem value="human_approval">
                            <div className="space-y-1">
                              <div className="flex items-center gap-2">
                                <Eye className="w-4 h-4" />
                                <span className="font-medium">Human Approval</span>
                              </div>
                              <div className="text-xs text-muted-foreground">Requires approval for high-risk actions</div>
                            </div>
                          </SelectItem>
                          <SelectItem value="manual">
                            <div className="space-y-1">
                              <div className="flex items-center gap-2">
                                <Settings className="w-4 h-4" />
                                <span className="font-medium">Manual</span>
                              </div>
                              <div className="text-xs text-muted-foreground">All actions require explicit approval</div>
                            </div>
                          </SelectItem>
                        </SelectContent>
                      </Select>
                      <p className="text-xs text-muted-foreground mt-1">
                        Controls how much autonomy the AI agent has during testing
                      </p>
                    </div>

                    {configuration.aiAgent.automationMode !== 'fully_automatic' && (
                      <div>
                        <Label htmlFor="approval-threshold">Approval Threshold</Label>
                        <Select 
                          value={configuration.aiAgent.approvalThreshold} 
                          onValueChange={(value: any) => updateAIAgentConfig('approvalThreshold', value)}
                        >
                          <SelectTrigger>
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="low">
                              <div className="flex items-center gap-2">
                                <Badge variant="secondary" className="text-xs">Low Risk</Badge>
                                <span>Approve all low-risk and above</span>
                              </div>
                            </SelectItem>
                            <SelectItem value="medium">
                              <div className="flex items-center gap-2">
                                <Badge variant="outline" className="text-xs">Medium Risk</Badge>
                                <span>Approve medium-risk and above</span>
                              </div>
                            </SelectItem>
                            <SelectItem value="high">
                              <div className="flex items-center gap-2">
                                <Badge variant="destructive" className="text-xs">High Risk</Badge>
                                <span>Only approve high-risk actions</span>
                              </div>
                            </SelectItem>
                            <SelectItem value="critical">
                              <div className="flex items-center gap-2">
                                <Badge variant="destructive" className="text-xs">Critical</Badge>
                                <span>Only critical actions need approval</span>
                              </div>
                            </SelectItem>
                          </SelectContent>
                        </Select>
                      </div>
                    )}

                    {/* Guardrails Configuration */}
                    <Separator />
                    <div className="space-y-3">
                      <div>
                        <Label className="text-sm font-medium">Guardrails Configuration</Label>
                        <p className="text-xs text-muted-foreground">Safety rules and restrictions for AI agent actions</p>
                      </div>
                      
                      <div className="space-y-3">
                        <div className="flex items-center justify-between">
                          <div className="space-y-1">
                            <Label className="text-sm">Block Destructive Commands</Label>
                            <p className="text-xs text-muted-foreground">Prevent execution of potentially harmful system commands</p>
                          </div>
                          <Switch
                            checked={configuration.aiAgent.guardrails.rules.blockDestructiveCommands}
                            onCheckedChange={(checked) => {
                              const newGuardrails = { ...configuration.aiAgent.guardrails };
                              newGuardrails.rules.blockDestructiveCommands = checked;
                              updateAIAgentConfig('guardrails', newGuardrails);
                            }}
                          />
                        </div>

                        <div className="flex items-center justify-between">
                          <div className="space-y-1">
                            <Label className="text-sm">Validate Target Scope</Label>
                            <p className="text-xs text-muted-foreground">Ensure all actions remain within defined scope</p>
                          </div>
                          <Switch
                            checked={configuration.aiAgent.guardrails.rules.validateTargetScope}
                            onCheckedChange={(checked) => {
                              const newGuardrails = { ...configuration.aiAgent.guardrails };
                              newGuardrails.rules.validateTargetScope = checked;
                              updateAIAgentConfig('guardrails', newGuardrails);
                            }}
                          />
                        </div>

                        <div className="flex items-center justify-between">
                          <div className="space-y-1">
                            <Label className="text-sm">Prevent Data Exfiltration</Label>
                            <p className="text-xs text-muted-foreground">Block commands that could extract sensitive data</p>
                          </div>
                          <Switch
                            checked={configuration.aiAgent.guardrails.rules.preventDataExfiltration}
                            onCheckedChange={(checked) => {
                              const newGuardrails = { ...configuration.aiAgent.guardrails };
                              newGuardrails.rules.preventDataExfiltration = checked;
                              updateAIAgentConfig('guardrails', newGuardrails);
                            }}
                          />
                        </div>

                        <div className="flex items-center justify-between">
                          <div className="space-y-1">
                            <Label className="text-sm">Limit Resource Usage</Label>
                            <p className="text-xs text-muted-foreground">Restrict CPU, memory, and network usage</p>
                          </div>
                          <Switch
                            checked={configuration.aiAgent.guardrails.rules.limitResourceUsage}
                            onCheckedChange={(checked) => {
                              const newGuardrails = { ...configuration.aiAgent.guardrails };
                              newGuardrails.rules.limitResourceUsage = checked;
                              updateAIAgentConfig('guardrails', newGuardrails);
                            }}
                          />
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>

                {/* Kali MCP Server Configuration */}
                <Card>
                  <CardHeader>
                    <CardTitle className="text-base flex items-center gap-2">
                      <Terminal className="w-4 h-4" />
                      Kali Linux MCP Server
                    </CardTitle>
                    <CardDescription>
                      Configure the Kali Linux Model Context Protocol server for tool execution
                    </CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div className="flex items-center justify-between">
                      <div className="space-y-1">
                        <Label className="text-sm font-medium">Enable Kali MCP Server</Label>
                        <p className="text-xs text-muted-foreground">Connect to a Kali Linux MCP server for secure tool execution</p>
                      </div>
                      <Switch
                        checked={configuration.aiAgent.kaliMCPServer.enabled}
                        onCheckedChange={(checked) => {
                          const newMCPServer = { ...configuration.aiAgent.kaliMCPServer };
                          newMCPServer.enabled = checked;
                          updateAIAgentConfig('kaliMCPServer', newMCPServer);
                        }}
                      />
                    </div>

                    {configuration.aiAgent.kaliMCPServer.enabled && (
                      <div className="space-y-4 p-3 border rounded-lg bg-muted/20">
                        <div className="grid grid-cols-2 gap-3">
                          <div>
                            <Label htmlFor="mcp-endpoint">Server Endpoint</Label>
                            <Input
                              id="mcp-endpoint"
                              value={configuration.aiAgent.kaliMCPServer.serverEndpoint}
                              onChange={(e) => {
                                const newMCPServer = { ...configuration.aiAgent.kaliMCPServer };
                                newMCPServer.serverEndpoint = e.target.value;
                                updateAIAgentConfig('kaliMCPServer', newMCPServer);
                              }}
                              placeholder="http://kali-mcp-server.local"
                            />
                          </div>
                          
                          <div>
                            <Label htmlFor="mcp-port">Port</Label>
                            <Input
                              id="mcp-port"
                              type="number"
                              value={configuration.aiAgent.kaliMCPServer.port}
                              onChange={(e) => {
                                const newMCPServer = { ...configuration.aiAgent.kaliMCPServer };
                                newMCPServer.port = parseInt(e.target.value) || 8080;
                                updateAIAgentConfig('kaliMCPServer', newMCPServer);
                              }}
                              placeholder="8080"
                            />
                          </div>
                        </div>

                        <div>
                          <Label className="text-sm font-medium">Enabled Tools</Label>
                          <p className="text-xs text-muted-foreground mb-2">Select which penetration testing tools are available</p>
                          <div className="grid grid-cols-3 gap-2">
                            {['nmap', 'sqlmap', 'nikto', 'gobuster', 'nuclei', 'amass', 'ffuf', 'dirb', 'whatweb', 'masscan'].map((tool) => (
                              <div key={tool} className="flex items-center space-x-2">
                                <Checkbox
                                  id={`tool-${tool}`}
                                  checked={configuration.aiAgent.kaliMCPServer.enabledTools.includes(tool)}
                                  onCheckedChange={(checked) => {
                                    const newMCPServer = { ...configuration.aiAgent.kaliMCPServer };
                                    if (checked) {
                                      newMCPServer.enabledTools = [...newMCPServer.enabledTools, tool];
                                    } else {
                                      newMCPServer.enabledTools = newMCPServer.enabledTools.filter(t => t !== tool);
                                    }
                                    updateAIAgentConfig('kaliMCPServer', newMCPServer);
                                  }}
                                />
                                <Label htmlFor={`tool-${tool}`} className="text-sm font-mono">{tool}</Label>
                              </div>
                            ))}
                          </div>
                        </div>

                        <div className="space-y-3">
                          <Label className="text-sm font-medium">Security Settings</Label>
                          
                          <div className="flex items-center justify-between">
                            <div className="space-y-1">
                              <Label className="text-sm">Sandbox Mode</Label>
                              <p className="text-xs text-muted-foreground">Run tools in isolated environment</p>
                            </div>
                            <Switch
                              checked={configuration.aiAgent.kaliMCPServer.securitySettings.sandboxMode}
                              onCheckedChange={(checked) => {
                                const newMCPServer = { ...configuration.aiAgent.kaliMCPServer };
                                newMCPServer.securitySettings.sandboxMode = checked;
                                updateAIAgentConfig('kaliMCPServer', newMCPServer);
                              }}
                            />
                          </div>

                          <div className="flex items-center justify-between">
                            <div className="space-y-1">
                              <Label className="text-sm">Allow Network Access</Label>
                              <p className="text-xs text-muted-foreground">Permit outbound network connections</p>
                            </div>
                            <Switch
                              checked={configuration.aiAgent.kaliMCPServer.securitySettings.allowNetworkAccess}
                              onCheckedChange={(checked) => {
                                const newMCPServer = { ...configuration.aiAgent.kaliMCPServer };
                                newMCPServer.securitySettings.allowNetworkAccess = checked;
                                updateAIAgentConfig('kaliMCPServer', newMCPServer);
                              }}
                            />
                          </div>
                        </div>
                      </div>
                    )}
                  </CardContent>
                </Card>

                {/* Online Research & HackTricks Integration */}
                <Card>
                  <CardHeader>
                    <CardTitle className="text-base flex items-center gap-2">
                      <BookOpen className="w-4 h-4" />
                      Online Research & HackTricks
                    </CardTitle>
                    <CardDescription>
                      Configure online research capabilities and HackTricks methodology integration
                    </CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    {/* HackTricks Integration */}
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <div className="space-y-1">
                          <Label className="text-sm font-medium">Enable HackTricks Integration</Label>
                          <p className="text-xs text-muted-foreground">Automatically load attack methodologies from HackTricks</p>
                        </div>
                        <Switch
                          checked={configuration.aiAgent.hackTricksIntegration.enabled}
                          onCheckedChange={(checked) => {
                            const newHackTricks = { ...configuration.aiAgent.hackTricksIntegration };
                            newHackTricks.enabled = checked;
                            updateAIAgentConfig('hackTricksIntegration', newHackTricks);
                          }}
                        />
                      </div>

                      {configuration.aiAgent.hackTricksIntegration.enabled && (
                        <div className="space-y-3 p-3 border rounded-lg bg-muted/20">
                          <div className="flex items-center justify-between">
                            <div className="space-y-1">
                              <Label className="text-sm">Auto-Load Methodology</Label>
                              <p className="text-xs text-muted-foreground">Automatically load relevant attack books</p>
                            </div>
                            <Switch
                              checked={configuration.aiAgent.hackTricksIntegration.autoLoadMethodology}
                              onCheckedChange={(checked) => {
                                const newHackTricks = { ...configuration.aiAgent.hackTricksIntegration };
                                newHackTricks.autoLoadMethodology = checked;
                                updateAIAgentConfig('hackTricksIntegration', newHackTricks);
                              }}
                            />
                          </div>

                          <div>
                            <Label className="text-sm font-medium">Preferred Categories</Label>
                            <p className="text-xs text-muted-foreground mb-2">Select which HackTricks categories to prioritize</p>
                            <div className="grid grid-cols-2 gap-2">
                              {['web', 'network', 'active-directory', 'kubernetes', 'cloud', 'mobile', 'windows', 'linux'].map((category) => (
                                <div key={category} className="flex items-center space-x-2">
                                  <Checkbox
                                    id={`category-${category}`}
                                    checked={configuration.aiAgent.hackTricksIntegration.preferredCategories.includes(category)}
                                    onCheckedChange={(checked) => {
                                      const newHackTricks = { ...configuration.aiAgent.hackTricksIntegration };
                                      if (checked) {
                                        newHackTricks.preferredCategories = [...newHackTricks.preferredCategories, category];
                                      } else {
                                        newHackTricks.preferredCategories = newHackTricks.preferredCategories.filter(c => c !== category);
                                      }
                                      updateAIAgentConfig('hackTricksIntegration', newHackTricks);
                                    }}
                                  />
                                  <Label htmlFor={`category-${category}`} className="text-sm capitalize">{category.replace('-', ' ')}</Label>
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>
                      )}
                    </div>

                    <Separator />

                    {/* Online Research */}
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <div className="space-y-1">
                          <Label className="text-sm font-medium">Enable Online Research</Label>
                          <p className="text-xs text-muted-foreground">Use online sources for real-time threat intelligence</p>
                        </div>
                        <Switch
                          checked={configuration.aiAgent.onlineResearch.enabled}
                          onCheckedChange={(checked) => {
                            const newResearch = { ...configuration.aiAgent.onlineResearch };
                            newResearch.enabled = checked;
                            updateAIAgentConfig('onlineResearch', newResearch);
                          }}
                        />
                      </div>

                      {configuration.aiAgent.onlineResearch.enabled && (
                        <div className="space-y-4 p-3 border rounded-lg bg-muted/20">
                          <div>
                            <Label className="text-sm font-medium">Research Providers</Label>
                            <p className="text-xs text-muted-foreground mb-2">Select which online sources to use</p>
                            <div className="space-y-2">
                              {Object.entries({
                                hacktricks: 'HackTricks.xyz',
                                perplexity: 'Perplexity AI',
                                shodan: 'Shodan',
                                cve: 'CVE Database',
                                exploit_db: 'Exploit Database'
                              }).map(([key, label]) => (
                                <div key={key} className="flex items-center space-x-2">
                                  <Checkbox
                                    id={`provider-${key}`}
                                    checked={configuration.aiAgent.onlineResearch.providers[key as keyof typeof configuration.aiAgent.onlineResearch.providers]}
                                    onCheckedChange={(checked) => {
                                      const newResearch = { ...configuration.aiAgent.onlineResearch };
                                      newResearch.providers = { ...newResearch.providers, [key]: checked };
                                      updateAIAgentConfig('onlineResearch', newResearch);
                                    }}
                                  />
                                  <Label htmlFor={`provider-${key}`} className="text-sm">{label}</Label>
                                </div>
                              ))}
                            </div>
                          </div>

                          <div>
                            <Label htmlFor="research-depth">Research Depth</Label>
                            <Select 
                              value={configuration.aiAgent.onlineResearch.researchDepth} 
                              onValueChange={(value: any) => {
                                const newResearch = { ...configuration.aiAgent.onlineResearch };
                                newResearch.researchDepth = value;
                                updateAIAgentConfig('onlineResearch', newResearch);
                              }}
                            >
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                              <SelectContent>
                                <SelectItem value="basic">Basic - Quick lookups only</SelectItem>
                                <SelectItem value="comprehensive">Comprehensive - Detailed research</SelectItem>
                                <SelectItem value="deep">Deep - Exhaustive analysis</SelectItem>
                              </SelectContent>
                            </Select>
                          </div>

                          <div className="flex items-center justify-between">
                            <div className="space-y-1">
                              <Label className="text-sm">Auto Research</Label>
                              <p className="text-xs text-muted-foreground">Automatically research new findings</p>
                            </div>
                            <Switch
                              checked={configuration.aiAgent.onlineResearch.autoResearch}
                              onCheckedChange={(checked) => {
                                const newResearch = { ...configuration.aiAgent.onlineResearch };
                                newResearch.autoResearch = checked;
                                updateAIAgentConfig('onlineResearch', newResearch);
                              }}
                            />
                          </div>
                        </div>
                      )}
                    </div>
                  </CardContent>
                </Card>

                {/* Agent Capabilities Overview */}
                <Card>
                  <CardHeader>
                    <CardTitle className="text-base">Agent Capabilities</CardTitle>
                    <CardDescription>
                      What the AI agent can do with the current configuration
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      <div className="space-y-2">
                        <div className="flex items-center gap-2">
                          <CheckCircle className="w-4 h-4 text-primary" />
                          <span>Automated vulnerability analysis</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <CheckCircle className="w-4 h-4 text-primary" />
                          <span>Intelligent attack path planning</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <CheckCircle className="w-4 h-4 text-primary" />
                          <span>Real-time threat correlation</span>
                        </div>
                        <div className="flex items-center gap-2">
                          {configuration.aiAgent.enableReasoningMode ? (
                            <CheckCircle className="w-4 h-4 text-primary" />
                          ) : (
                            <span className="w-4 h-4 rounded-full bg-muted" />
                          )}
                          <span className={configuration.aiAgent.enableReasoningMode ? '' : 'text-muted-foreground'}>
                            Advanced reasoning & multi-step analysis
                          </span>
                        </div>
                      </div>
                      <div className="space-y-2">
                        <div className="flex items-center gap-2">
                          <CheckCircle className="w-4 h-4 text-primary" />
                          <span>Comprehensive report generation</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <CheckCircle className="w-4 h-4 text-primary" />
                          <span>Risk assessment & prioritization</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <CheckCircle className="w-4 h-4 text-primary" />
                          <span>Remediation recommendations</span>
                        </div>
                        <div className="flex items-center gap-2">
                          {configuration.aiAgent.streamingEnabled ? (
                            <CheckCircle className="w-4 h-4 text-primary" />
                          ) : (
                            <span className="w-4 h-4 rounded-full bg-muted" />
                          )}
                          <span className={configuration.aiAgent.streamingEnabled ? '' : 'text-muted-foreground'}>
                            Real-time streaming updates
                          </span>
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </TabsContent>
              
              <TabsContent value="settings" className="space-y-4 mt-0">
                <Card>
                  <CardHeader>
                    <CardTitle className="text-base flex items-center gap-2">
                      <Gauge className="w-4 h-4" />
                      Global Settings
                    </CardTitle>
                    <CardDescription>
                      Configure global penetration test parameters
                    </CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div>
                      <div className="flex items-center justify-between mb-2">
                        <Label className="text-sm font-medium">Global Aggression Level</Label>
                        <Badge variant="outline" className="text-xs">
                          {configuration.globalSettings.aggressionLevel}/5
                        </Badge>
                      </div>
                      <Slider
                        value={[configuration.globalSettings.aggressionLevel]}
                        onValueChange={([value]) => updateGlobalSettings('aggressionLevel', value)}
                        max={5}
                        min={1}
                        step={1}
                        className="w-full"
                      />
                      <div className="flex justify-between text-xs text-muted-foreground mt-1">
                        <span>Conservative</span>
                        <span>Aggressive</span>
                      </div>
                    </div>
                    
                    <Separator />
                    
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <Label htmlFor="timeout" className="text-sm">Timeout (seconds)</Label>
                        <Input
                          id="timeout"
                          type="number"
                          value={configuration.globalSettings.timeout}
                          onChange={(e) => updateGlobalSettings('timeout', parseInt(e.target.value) || 300)}
                          min={30}
                          max={3600}
                        />
                      </div>
                      
                      <div>
                        <Label htmlFor="retries" className="text-sm">Max Retries</Label>
                        <Input
                          id="retries"
                          type="number"
                          value={configuration.globalSettings.retries}
                          onChange={(e) => updateGlobalSettings('retries', parseInt(e.target.value) || 3)}
                          min={1}
                          max={10}
                        />
                      </div>
                    </div>
                    
                    <div>
                      <Label htmlFor="concurrency" className="text-sm">Concurrency Level</Label>
                      <Input
                        id="concurrency"
                        type="number"
                        value={configuration.globalSettings.concurrency}
                        onChange={(e) => updateGlobalSettings('concurrency', parseInt(e.target.value) || 5)}
                        min={1}
                        max={50}
                      />
                    </div>
                    
                    <Separator />
                    
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <Label htmlFor="stealth" className="text-sm">Stealth Mode</Label>
                        <Switch
                          id="stealth"
                          checked={configuration.globalSettings.stealth}
                          onCheckedChange={(checked) => updateGlobalSettings('stealth', checked)}
                        />
                      </div>
                      
                      <div className="flex items-center justify-between">
                        <Label htmlFor="automated" className="text-sm">Fully Automated</Label>
                        <Switch
                          id="automated"
                          checked={configuration.globalSettings.automated}
                          onCheckedChange={(checked) => updateGlobalSettings('automated', checked)}
                        />
                      </div>
                    </div>
                    
                    <div>
                      <Label htmlFor="reporting" className="text-sm">Reporting Level</Label>
                      <Select
                        value={configuration.globalSettings.reportingLevel}
                        onValueChange={(value: any) => updateGlobalSettings('reportingLevel', value)}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="minimal">Minimal</SelectItem>
                          <SelectItem value="standard">Standard</SelectItem>
                          <SelectItem value="comprehensive">Comprehensive</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>
                  </CardContent>
                </Card>
                
                <Card>
                  <CardHeader>
                    <CardTitle className="text-base">Configuration Summary</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      <div className="space-y-2">
                        <div className="flex justify-between">
                          <span className="text-muted-foreground">Enabled Modules:</span>
                          <span className="font-medium">
                            {configuration.modules.filter(m => m.enabled).length}
                          </span>
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </TabsContent>
              </div>
            </ScrollArea>
          </Tabs>
        </div>
      </div>

      {/* System Prompt Manager Dialog */}
      {showPromptManager && (
        <Dialog open={showPromptManager} onOpenChange={setShowPromptManager}>
          <DialogContent className="max-w-4xl h-[80vh] p-0 overflow-hidden">
            <DialogHeader className="p-6 pb-4 flex-shrink-0">
              <DialogTitle className="flex items-center gap-2">
                <Settings className="h-5 w-5" />
                System Prompt Manager
              </DialogTitle>
              <DialogDescription>
                Manage and configure AI agent system prompts for different penetration testing scenarios
              </DialogDescription>
            </DialogHeader>
            
            <ScrollArea className="flex-1">
              <div className="p-6 pt-2 space-y-6">
              {/* Preset Prompts */}
              <div>
                <h3 className="text-lg font-semibold mb-3">Preset Prompts</h3>
                <div className="grid gap-4">
                  {Object.entries(configuration.aiAgent.customSystemPrompts).map(([key, prompt]) => (
                    <Card key={key} className="p-4">
                      <div className="flex items-start justify-between mb-2">
                        <div>
                          <h4 className="font-medium capitalize">{key.replace('-', ' ')}</h4>
                          <p className="text-sm text-muted-foreground">
                            {prompt.length > 100 ? `${prompt.substring(0, 100)}...` : prompt}
                          </p>
                        </div>
                        <Button
                          size="sm"
                          variant="outline"
                          onClick={() => handleSystemPromptPreset(key)}
                          disabled={configuration.aiAgent.systemPromptPreset === key}
                        >
                          Use This
                        </Button>
                      </div>
                    </Card>
                  ))}
                </div>
              </div>

              <Separator />

              {/* Create New Prompt */}
              <div>
                <h3 className="text-lg font-semibold mb-3">Create Custom Prompt</h3>
                <div className="space-y-4">
                  <div>
                    <Label htmlFor="new-prompt-name">Prompt Name</Label>
                    <Input
                      id="new-prompt-name"
                      value={newPromptName}
                      onChange={(e) => setNewPromptName(e.target.value)}
                      placeholder="e.g., web-app-specialist"
                    />
                  </div>
                  
                  <div>
                    <Label htmlFor="new-prompt-content">Prompt Content</Label>
                    <Textarea
                      id="new-prompt-content"
                      value={newPromptContent}
                      onChange={(e) => setNewPromptContent(e.target.value)}
                      placeholder="You are an expert cybersecurity AI agent..."
                      rows={8}
                      className="text-sm"
                    />
                  </div>

                  <div className="flex justify-end gap-2">
                    <Button
                      variant="outline"
                      onClick={() => {
                        setNewPromptName('');
                        setNewPromptContent('');
                      }}
                    >
                      Clear
                    </Button>
                    <Button
                      onClick={() => {
                        saveCustomSystemPrompt(newPromptName, newPromptContent);
                        setNewPromptName('');
                        setNewPromptContent('');
                      }}
                      disabled={!newPromptName.trim() || !newPromptContent.trim()}
                    >
                      Save Prompt
                    </Button>
                  </div>
                </div>
              </div>
              </div>
            </ScrollArea>
          </DialogContent>
        </Dialog>
      )}
    </div>
  );
};